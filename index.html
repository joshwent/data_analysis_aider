<!DOCTYPE html>
<html>
<head>
    <title>Game Analytics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.1/dist/darkly/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="dash-container"></div>
    
    <script type="module">
        async function initDashApp() {
            try {
                let pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                console.log("Pyodide loaded successfully");
                
                document.getElementById('dash-container').innerHTML = 
                    '<div class="loading">Loading dashboard...</div>';
                
                // Load micropip and base packages first
                await pyodide.loadPackage(['micropip', 'pandas', 'numpy']);
                console.log("Base packages loaded successfully");
                
                // Install additional packages via micropip
                await pyodide.runPythonAsync(`
import micropip
print("Installing additional packages...")
await micropip.install([
    'beautifulsoup4',
    'plotly',
    'dash',
    'dash-core-components',
    'dash-html-components',
    'dash-bootstrap-components'
])
print("Additional packages installed successfully")

# Patch Dash to work without a server
import dash
dash.Dash._serve_default_favicon = lambda self: None
dash.Dash._setup_dev_tools = lambda self, **kwargs: None
dash.Dash._add_assets_resource = lambda self, *args, **kwargs: None
dash.Dash.run_server = lambda self, *args, **kwargs: None
`);
                
                const analysisResponse = await fetch('analysis.py');
                const analysisCode = await analysisResponse.text();
                
                const parserResponse = await fetch('html_parser.py');
                const parserCode = await parserResponse.text();
                
                await pyodide.runPythonAsync(`
import sys
import os

# Create a virtual module for html_parser
html_parser_code = ${JSON.stringify(parserCode)}
import types
html_parser = types.ModuleType('html_parser')
exec(html_parser_code, html_parser.__dict__)
sys.modules['html_parser'] = html_parser

# Import required packages
from dash import Dash, html, dcc
import dash_bootstrap_components as dbc

# Configure Dash for browser use
app = Dash(__name__, 
    external_stylesheets=[dbc.themes.DARKLY],
    meta_tags=[{'name': 'viewport',
                'content': 'width=device-width, initial-scale=1.0'}],
    suppress_callback_exceptions=True,
    use_pages=False)

# Execute the analysis code
${analysisCode}

# Get the app's HTML and callbacks
dashboard_html = app.index()

# Initialize client-side callbacks
app._inline_scripts = []
for callback in app._callback_list:
    callback.output._set_allow_duplicate(True)
    app._inline_scripts.append(callback._build_callback_script())
`);

                // Get the HTML from Python and insert it into the container
                const container = document.getElementById('dash-container');
                container.innerHTML = pyodide.globals.get('dashboard_html');

                // Get and execute callback scripts
                const callbackScripts = pyodide.globals.get('app._inline_scripts');
                for (const script of callbackScripts) {
                    const scriptEl = document.createElement('script');
                    scriptEl.textContent = script;
                    document.body.appendChild(scriptEl);
                }

                console.log("Dashboard fully initialized");
                
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                document.getElementById('dash-container').innerHTML = 
                    `<div class="error">Error loading dashboard: ${error.message}</div>`;
            }
        }

        initDashApp();
    </script>
</body>
</html>
