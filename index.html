<!DOCTYPE html>
<html>
<head>
    <title>Game Analytics</title>
    <link rel="stylesheet" href="https://raw.githubusercontent.com/joshwent/data_analysis/refs/heads/main/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.1/dist/darkly/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
    <div id="dash-container"></div>
    
    <script type="module">
        async function initDashApp() {
            try {
                let pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                console.log("Pyodide loaded successfully");
                
                document.getElementById('dash-container').innerHTML = 
                    '<div class="loading">Loading dashboard...</div>';
                
                // Load micropip and base packages first
                await pyodide.loadPackage(['micropip', 'pandas', 'numpy']);
                console.log("Base packages loaded successfully");
                
                // Install additional packages via micropip
                await pyodide.runPythonAsync(`
import micropip
print("Installing additional packages...")
await micropip.install([
    'beautifulsoup4',
    'plotly',
    'dash',
    'dash-core-components',
    'dash-html-components',
    'dash-bootstrap-components'
], keep_going=True)  # Add keep_going=True to see all package issues
print("Additional packages installed successfully")
`);
                
                const analysisResponse = await fetch('https://raw.githubusercontent.com/joshwent/data_analysis/refs/heads/main/analysis.py');
                const analysisCode = await analysisResponse.text();
                
                const parserResponse = await fetch('https://raw.githubusercontent.com/joshwent/data_analysis/refs/heads/main/html_parser.py');
                const parserCode = await parserResponse.text();
                
                await pyodide.runPythonAsync(`
import sys
import os

# Create a virtual module for html_parser
html_parser_code = ${JSON.stringify(parserCode)}
import types
html_parser = types.ModuleType('html_parser')
exec(html_parser_code, html_parser.__dict__)
sys.modules['html_parser'] = html_parser

# Import required packages
from dash import Dash, html
import dash_bootstrap_components as dbc

# Configure Dash for browser use
app = Dash(__name__, 
          external_stylesheets=[dbc.themes.DARKLY],
          meta_tags=[{'name': 'viewport',
                     'content': 'width=device-width, initial-scale=1.0'}],
          suppress_callback_exceptions=True)

# Now execute the analysis code
${analysisCode}

# Get the app's HTML
dashboard_html = app.index()
`);

                // Get the HTML from Python and insert it into the container
                const container = document.getElementById('dash-container');
                container.innerHTML = pyodide.globals.get('dashboard_html');

                // Initialize the callbacks
                await pyodide.runPythonAsync(`
# Initialize the app's callbacks
app._setup_server()

# Register and activate callbacks
for callback_id, callback_info in app.callback_map.items():
    callback_info['callback'].allow_duplicate = True
    
app._activate_callbacks()

# Force layout update
app.layout = app.layout
`);

                // Trigger initial update
                const dashContainer = document.getElementById('dash-container');
                const event = new Event('DOMContentLoaded');
                dashContainer.dispatchEvent(event);
                
                console.log("Dashboard fully initialized");
                
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                document.getElementById('dash-container').innerHTML = 
                    `<div class="error">Error loading dashboard: ${error.message}</div>`;
            }
        }

        initDashApp();
    </script>
</body>
</html>
