<!DOCTYPE html>
<html>
<head>
    <title>Game Analytics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.1/dist/darkly/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container-fluid" style="max-width: 1400px;">
        <!-- Data Import Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="bg-card p-4 rounded">
                    <h2 class="text-primary mb-3">Data Import</h2>
                    <button id="load-example-data" class="btn btn-secondary w-100 mb-3">
                        Load Example Data
                    </button>
                    <div class="text-center mb-3 text-secondary">- or -</div>
                    <div id="upload-zone" class="border border-dashed rounded p-3 text-center">
                        <div>Drag and Drop or</div>
                        <button class="btn btn-primary btn-sm ms-2">Select HTML File</button>
                        <input type="file" id="file-input" style="display: none;" accept=".html">
                    </div>
                    <div id="upload-status" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Filters Sidebar -->
            <div class="col-3">
                <div class="bg-card p-4 rounded">
                    <h2 class="text-primary mb-3">Filters</h2>
                    <div class="accordion" id="filterAccordion">
                        <!-- Operators Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#operatorCollapse">
                                    Operators
                                </button>
                            </h2>
                            <div id="operatorCollapse" class="accordion-collapse collapse show">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <button id="operator-select-all" class="btn btn-primary btn-sm me-2">Select All</button>
                                        <button id="operator-deselect-all" class="btn btn-secondary btn-sm">Deselect All</button>
                                    </div>
                                    <div id="operator-checklist" class="filter-checklist"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Game Types Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gameTypeCollapse">
                                    Game Types
                                </button>
                            </h2>
                            <div id="gameTypeCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <button id="game-type-select-all" class="btn btn-primary btn-sm me-2">Select All</button>
                                        <button id="game-type-deselect-all" class="btn btn-secondary btn-sm">Deselect All</button>
                                    </div>
                                    <div id="game-type-checklist" class="filter-checklist"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Maps Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mapCollapse">
                                    Maps
                                </button>
                            </h2>
                            <div id="mapCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <button id="map-select-all" class="btn btn-primary btn-sm me-2">Select All</button>
                                        <button id="map-deselect-all" class="btn btn-secondary btn-sm">Deselect All</button>
                                    </div>
                                    <div id="map-checklist" class="filter-checklist"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Date Range Picker -->
                    <div class="mt-4">
                        <label class="form-label">Date Range</label>
                        <input type="date" id="date-start" class="form-control mb-2">
                        <input type="date" id="date-end" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-9">
                <div id="stats-container"></div>
                <hr class="my-4">
                <div id="plots-container" class="plots-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let globalData = null;
        let pyodide = null;

        // Initialize Pyodide and load dependencies
        async function initPyodide() {
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                console.log("Pyodide loaded");

                // Load required packages
                await pyodide.loadPackage(['micropip']);
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install(['pandas', 'beautifulsoup4'])
                    print("Required packages installed")
                `);

                // Load the HTML parser
                const response = await fetch('https://raw.githubusercontent.com/joshwent/data_analysis/refs/heads/main/html_parser.py');
                const parserContent = await response.text();
                pyodide.runPython(parserContent);
                console.log("HTML parser loaded");

            } catch (error) {
                console.error("Initialization error:", error);
                showError("Failed to initialize Python environment: " + error.message);
            }
        }

        // Utility functions
        function showError(message) {
            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        function showSuccess(message) {
            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerHTML = `<div class="alert alert-success">${message}</div>`;
        }

        // File handling
        async function handleFileUpload(file) {
            try {
                const content = await file.text();
                const result = await pyodide.runPythonAsync(`
                    from html_parser import parse_html_file
                    df = parse_html_file('''${content}''')
                    df.to_json(orient='records')
                `);
                
                globalData = JSON.parse(result);
                console.log("Data loaded:", globalData.length, "records");
                
                updateFilters();
                updateStats();
                updatePlots();
                showSuccess("Data loaded successfully");
                
            } catch (error) {
                console.error("Error processing file:", error);
                showError("Error processing file: " + error.message);
            }
        }

        // Filter management
        function updateFilters() {
            if (!globalData) return;
            
            // Get unique values
            const operators = [...new Set(globalData.map(d => d.Operator))].sort();
            const gameTypes = [...new Set(globalData.map(d => d['Game Type']))].sort();
            const maps = [...new Set(globalData.map(d => d.Map))].sort();
            
            // Update operator checklist
            const operatorList = document.getElementById('operator-checklist');
            operatorList.innerHTML = operators.map(op => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${op}" id="op-${op}" checked>
                    <label class="form-check-label" for="op-${op}">${op}</label>
                </div>
            `).join('');
            
            // Update game type checklist
            const gameTypeList = document.getElementById('game-type-checklist');
            gameTypeList.innerHTML = gameTypes.map(type => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${type}" id="gt-${type}" checked>
                    <label class="form-check-label" for="gt-${type}">${type}</label>
                </div>
            `).join('');
            
            // Update maps checklist
            const mapList = document.getElementById('map-checklist');
            mapList.innerHTML = maps.map(map => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${map}" id="map-${map}" checked>
                    <label class="form-check-label" for="map-${map}">${map}</label>
                </div>
            `).join('');
            
            // Update date range
            const dates = globalData.map(d => new Date(d['UTC Timestamp']));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            document.getElementById('date-start').value = minDate.toISOString().split('T')[0];
            document.getElementById('date-end').value = maxDate.toISOString().split('T')[0];
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Pyodide
            await initPyodide();
            
            // File upload handling
            const fileInput = document.getElementById('file-input');
            const uploadZone = document.getElementById('upload-zone');
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFileUpload(file);
            });
            
            uploadZone.addEventListener('click', () => fileInput.click());
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-over');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) handleFileUpload(file);
            });
            
            // Select/Deselect all buttons
            document.getElementById('operator-select-all').addEventListener('click', () => {
                document.querySelectorAll('#operator-checklist input[type="checkbox"]')
                    .forEach(cb => cb.checked = true);
                updateStats();
                updatePlots();
            });
            
            document.getElementById('operator-deselect-all').addEventListener('click', () => {
                document.querySelectorAll('#operator-checklist input[type="checkbox"]')
                    .forEach(cb => cb.checked = false);
                updateStats();
                updatePlots();
            });
            
            // Repeat for game types and maps...
            // Add similar event listeners for other select/deselect buttons
        });
    </script>
</body>
</html>
