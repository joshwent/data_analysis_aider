<!DOCTYPE html>
<html>
<head>
    <title>Game Analytics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.1/dist/darkly/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <div id="app">
        <div id="loading" class="loading">Loading Python environment...</div>
        <div id="error" class="error" style="display:none"></div>
        <div id="content" style="display:none">
            <!-- Dash app will be mounted here -->
        </div>
    </div>

    <script>
        async function initPyodide() {
            try {
                // Initialize Pyodide
                let pyodide = await loadPyodide();
                console.log("Pyodide initialized");
                
                // Install micropip first
                await pyodide.loadPackage('micropip');
                console.log("Micropip installed");
                
                // Use micropip to install required packages
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install('plotly')
                    await micropip.install('dash')
                    await micropip.install('dash-core-components')
                    await micropip.install('dash-html-components')
                    await micropip.install('dash-bootstrap-components')
                    await micropip.install('beautifulsoup4')
                `);
                console.log("Required packages installed");
                
                // Now load numpy and pandas
                await pyodide.loadPackage(['numpy', 'pandas']);
                console.log("Numpy and Pandas loaded");
                
                // Load html_parser.py first since analysis.py depends on it
                const parserResponse = await fetch('https://raw.githubusercontent.com/joshwent/data_analysis/refs/heads/main/html_parser.py');
                const parserCode = await parserResponse.text();
                pyodide.FS.writeFile('html_parser.py', parserCode);
                console.log("HTML parser loaded");
                
                // Then load analysis.py
                const analysisResponse = await fetch('https://raw.githubusercontent.com/joshwent/data_analysis/refs/heads/main/analysis.py');
                const analysisCode = await analysisResponse.text();
                pyodide.FS.writeFile('analysis.py', analysisCode);
                console.log("Analysis code loaded");
                
                // Now run the Python code and display the Dash app
                await pyodide.runPythonAsync(`
                    import sys
                    import html_parser
                    import analysis
                    from dash import no_update
                    import dash.exceptions
                    
                    # Initialize the app
                    app = analysis.app
                    
                    # Create the initial layout
                    layout_html = app.layout.to_plotly_json()
                    
                    # Convert to HTML string
                    from dash.html import ComponentMeta
                    html_string = ComponentMeta.to_html(layout_html)
                    
                    # Insert into content div
                    from js import document
                    content_div = document.getElementById('content')
                    content_div.innerHTML = html_string
                    
                    # Initialize the callbacks
                    app._setup_dev_tools()
                    app._setup_server()
                    
                    print("App initialization complete", file=sys.stderr)
                `);
                console.log("Python code executed");
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                console.log("Display updated");
                
            } catch (error) {
                console.error("Initialization error:", error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `Error initializing: ${error}`;
                errorDiv.style.display = 'block';
            }
        }

        // Start initialization when page loads
        window.addEventListener('load', initPyodide);
    </script>
</body>
</html>
